{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}{{ title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
.select2-container {
    width: 100% !important;
}
.select2-container--bootstrap-5 .select2-selection {
    min-height: 38px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-plus-circle me-2"></i>{{ title }}</h2>
        </div>
        <div class="col-auto">
            <a href="{% url 'inventory:purchase_order_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to List
            </a>
        </div>
    </div>

    <form method="post" id="purchaseOrderForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Order Information -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Order Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.supplier.id_for_label }}" class="form-label">Supplier *</label>
                            {{ form.supplier }}
                            {% if form.supplier.errors %}
                                <div class="text-danger">{{ form.supplier.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.expected_delivery_date.id_for_label }}" class="form-label">Expected Delivery Date</label>
                            {{ form.expected_delivery_date }}
                            {% if form.expected_delivery_date.errors %}
                                <div class="text-danger">{{ form.expected_delivery_date.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.notes.id_for_label }}" class="form-label">Notes</label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="text-danger">{{ form.notes.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Order Items</h5>
                        <button type="button" class="btn btn-sm btn-light" onclick="addOrderItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> You only need to specify items and quantities. The supplier will provide pricing and delivery date when they approve the order.
                        </div>
                        <div id="orderItemsContainer">
                            <!-- Order items will be added here dynamically -->
                        </div>
                        <div class="alert alert-info" id="noItemsAlert">
                            <i class="fas fa-info-circle me-2"></i>Click "Add Item" to start adding items to your purchase order.
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-12">
                                <strong>Total Items:</strong> <span id="totalItems">0</span>
                                <br>
                                <small class="text-muted">Pricing will be provided by supplier during approval</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden field to track item count -->
        <input type="hidden" name="item_count" id="itemCount" value="0">

        <!-- Submit Button -->
        <div class="row">
            <div class="col-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'inventory:purchase_order_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Create Purchase Order
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
let itemCounter = 0;

// Convert Django QuerySet to JSON-friendly format
const itemsData = [
    {% for item in items %}
    {
        id: "{{ item.id }}",
        name: "{{ item.name|escapejs }}",
        code: "{{ item.code }}",
        unit: "{{ item.unit }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function addOrderItem() {
    const container = document.getElementById('orderItemsContainer');
    const itemDiv = document.createElement('div');
    itemDiv.className = 'order-item-row card mb-3';
    itemDiv.id = `orderItem_${itemCounter}`;
    
    itemDiv.innerHTML = `
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-5">
                    <label class="form-label">Item</label>
                    <select name="item_${itemCounter}" class="form-select item-select" onchange="updateTotal()" required>
                        <option value="">Select Item</option>
                        ${itemsData.map(item => `<option value="${item.id}">${item.name} (${item.code})</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Quantity Needed</label>
                    <input type="number" name="qty_${itemCounter}" class="form-control qty-input" step="0.01" min="0.01" onchange="updateTotal()" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger w-100" onclick="removeOrderItem(${itemCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <label class="form-label">Notes (Optional)</label>
                    <input type="text" name="item_notes_${itemCounter}" class="form-control" placeholder="Additional notes for this item">
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(itemDiv);
    
    // Initialize Select2 on the newly added select element
    $(`#orderItem_${itemCounter} .item-select`).select2({
        theme: 'bootstrap-5',
        placeholder: 'Search for an item...',
        allowClear: true,
        width: '100%'
    });
    
    itemCounter++;
    document.getElementById('itemCount').value = itemCounter;
    document.getElementById('noItemsAlert').style.display = 'none';
    updateTotal();
}

function removeOrderItem(index) {
    const itemDiv = document.getElementById(`orderItem_${index}`);
    if (itemDiv) {
        itemDiv.remove();
        updateTotal();
        
        // Check if there are no items left
        const container = document.getElementById('orderItemsContainer');
        if (container.children.length === 0) {
            document.getElementById('noItemsAlert').style.display = 'block';
        }
    }
}

function updateTotal() {
    let totalItems = 0;
    
    const itemRows = document.querySelectorAll('.order-item-row');
    itemRows.forEach(row => {
        const qtyInput = row.querySelector('.qty-input');
        
        if (qtyInput && qtyInput.value) {
            totalItems++;
        }
    });
    
    document.getElementById('totalItems').textContent = totalItems;
}

// Add first item on page load
document.addEventListener('DOMContentLoaded', function() {
    addOrderItem();
});

// Form validation
document.getElementById('purchaseOrderForm').addEventListener('submit', function(e) {
    const itemCount = document.getElementById('orderItemsContainer').children.length;
    if (itemCount === 0) {
        e.preventDefault();
        alert('Please add at least one item to the purchase order.');
        return false;
    }
});
</script>
{% endblock %}

