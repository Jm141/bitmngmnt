{% extends 'inventory/base.html' %}

{% block title %}Receive Order {{ order.order_no }}{% endblock %}
{% block page_title %}Receive Purchase Order{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div class="space-y-1">
            <h1 class="font-serif text-3xl md:text-4xl tracking-tight">
                Receive Order: {{ order.order_no }}
            </h1>
            <p class="text-muted-foreground">Review items and set expiration dates before accepting delivery</p>
        </div>
        <a href="{% url 'inventory:purchase_order_detail' order.id %}" class="btn btn-outline">
            <i class="fas fa-arrow-left mr-2"></i>Back to Order
        </a>
    </div>

    <!-- Order Info Card -->
    <div class="card">
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-muted-foreground">Supplier</p>
                    <p class="font-semibold">{{ order.supplier.name }}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Order Date</p>
                    <p class="font-semibold">{{ order.order_date|date:"M d, Y" }}</p>
                </div>
                <div>
                    <p class="text-sm text-muted-foreground">Total Amount</p>
                    <p class="font-semibold text-green-600">â‚±{{ order.total_amount|floatformat:2 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Items to Receive -->
    <form method="post" id="receiveForm">
        {% csrf_token %}
        <div class="card">
            <div class="card-header border-b">
                <h3 class="text-lg font-semibold">Items to Receive</h3>
                <p class="text-sm text-muted-foreground mt-1">Set expiration dates for perishable items</p>
            </div>
            <div class="card-body">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-3 text-sm font-medium text-muted-foreground">Item</th>
                                <th class="text-left py-3 text-sm font-medium text-muted-foreground">Category</th>
                                <th class="text-right py-3 text-sm font-medium text-muted-foreground">Qty Ordered</th>
                                <th class="text-right py-3 text-sm font-medium text-muted-foreground">Qty to Receive</th>
                                <th class="text-left py-3 text-sm font-medium text-muted-foreground">Lot Number</th>
                                <th class="text-left py-3 text-sm font-medium text-muted-foreground">Expiration Date</th>
                                <th class="text-left py-3 text-sm font-medium text-muted-foreground">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order_items %}
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-3">
                                    <div class="flex items-center">
                                        {% if item.item.is_perishable %}
                                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2" title="Perishable item"></i>
                                        {% endif %}
                                        <div>
                                            <p class="font-medium">{{ item.item.name }}</p>
                                            <p class="text-xs text-muted-foreground">{{ item.item.code }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ item.item.get_category_display }}
                                    </span>
                                </td>
                                <td class="py-3 text-right">
                                    <span class="font-medium">{{ item.qty_ordered }} {{ item.get_unit_display }}</span>
                                </td>
                                <td class="py-3 text-right">
                                    <input 
                                        type="number" 
                                        name="qty_received_{{ item.id }}" 
                                        value="{{ item.qty_ordered }}" 
                                        step="0.01"
                                        min="0"
                                        max="{{ item.qty_ordered }}"
                                        class="form-input w-24 text-right"
                                        required
                                    >
                                </td>
                                <td class="py-3">
                                    <input 
                                        type="text" 
                                        name="lot_no_{{ item.id }}" 
                                        placeholder="LOT-{{ order.order_no }}-{{ forloop.counter }}"
                                        value="LOT-{{ order.order_no }}-{{ forloop.counter }}"
                                        class="form-input w-full"
                                        required
                                    >
                                </td>
                                <td class="py-3">
                                    <input 
                                        type="date" 
                                        name="expires_at_{{ item.id }}" 
                                        class="form-input w-full {% if item.item.is_perishable %}border-yellow-500{% endif %}"
                                        {% if item.item.is_perishable %}required{% endif %}
                                        min="{{ today|date:'Y-m-d' }}"
                                    >
                                    {% if item.item.is_perishable and item.item.shelf_life_days > 0 %}
                                        <p class="text-xs text-yellow-600 mt-1">
                                            Shelf life: {{ item.item.shelf_life_days }} days
                                        </p>
                                    {% endif %}
                                </td>
                                <td class="py-3">
                                    <input 
                                        type="text" 
                                        name="notes_{{ item.id }}" 
                                        placeholder="Optional notes"
                                        class="form-input w-full"
                                    >
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Delivery Notes -->
                <div class="mt-6 space-y-4">
                    <div>
                        <label class="form-label">Delivery Notes (Optional)</label>
                        <textarea 
                            name="delivery_notes" 
                            rows="3" 
                            class="form-input w-full"
                            placeholder="Any notes about the delivery condition, packaging, etc."
                        ></textarea>
                    </div>

                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="confirm_quality" 
                            name="confirm_quality" 
                            class="mr-2"
                            required
                        >
                        <label for="confirm_quality" class="text-sm">
                            I confirm that all items have been inspected and are in good condition
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end gap-3 mt-6">
            <a href="{% url 'inventory:purchase_order_detail' order.id %}" class="btn btn-outline">
                <i class="fas fa-times mr-2"></i>Cancel
            </a>
            <button type="button" onclick="previewReceiving()" class="btn btn-secondary">
                <i class="fas fa-eye mr-2"></i>Preview
            </button>
            <button type="submit" class="btn btn-success">
                <i class="fas fa-check mr-2"></i>Accept & Receive Order
            </button>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal" style="display: none;">
    <div class="modal-overlay" onclick="closePreview()"></div>
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="text-xl font-semibold">Review Receiving Details</h3>
            <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="previewContent">
            <!-- Preview content will be inserted here -->
        </div>
        <div class="modal-footer">
            <button onclick="closePreview()" class="btn btn-outline">Close</button>
            <button onclick="submitForm()" class="btn btn-success">
                <i class="fas fa-check mr-2"></i>Confirm & Receive
            </button>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
}

.modal-content {
    position: relative;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    max-height: 90vh;
    overflow-y: auto;
    width: 90%;
    margin: 20px;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
}
</style>

<script>
function previewReceiving() {
    const form = document.getElementById('receiveForm');
    const formData = new FormData(form);
    let previewHTML = '<div class="space-y-4">';
    
    previewHTML += '<h4 class="font-semibold mb-2">Items to be received:</h4>';
    previewHTML += '<table class="w-full text-sm"><thead><tr class="border-b"><th class="text-left py-2">Item</th><th class="text-right py-2">Qty</th><th class="text-left py-2">Lot</th><th class="text-left py-2">Expires</th></tr></thead><tbody>';
    
    {% for item in order_items %}
    const qty_{{ item.id }} = formData.get('qty_received_{{ item.id }}');
    const lot_{{ item.id }} = formData.get('lot_no_{{ item.id }}');
    const expires_{{ item.id }} = formData.get('expires_at_{{ item.id }}');
    const notes_{{ item.id }} = formData.get('notes_{{ item.id }}');
    
    previewHTML += `<tr class="border-b">
        <td class="py-2">{{ item.item.name }}</td>
        <td class="text-right py-2">${qty_{{ item.id }}} {{ item.get_unit_display }}</td>
        <td class="py-2">${lot_{{ item.id }}}</td>
        <td class="py-2">${expires_{{ item.id }} || '<span class="text-gray-400">No expiry</span>'}</td>
    </tr>`;
    {% endfor %}
    
    previewHTML += '</tbody></table>';
    
    const deliveryNotes = formData.get('delivery_notes');
    if (deliveryNotes) {
        previewHTML += `<div class="mt-4"><strong>Delivery Notes:</strong><p class="text-gray-600 mt-1">${deliveryNotes}</p></div>`;
    }
    
    previewHTML += '</div>';
    
    document.getElementById('previewContent').innerHTML = previewHTML;
    document.getElementById('previewModal').style.display = 'flex';
}

function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

function submitForm() {
    document.getElementById('receiveForm').submit();
}

// Auto-calculate expiration date based on shelf life
document.addEventListener('DOMContentLoaded', function() {
    {% for item in order_items %}
    {% if item.item.is_perishable and item.item.shelf_life_days > 0 %}
    const expiryInput_{{ item.id }} = document.querySelector('input[name="expires_at_{{ item.id }}"]');
    if (expiryInput_{{ item.id }} && !expiryInput_{{ item.id }}.value) {
        const today = new Date();
        today.setDate(today.getDate() + {{ item.item.shelf_life_days }});
        expiryInput_{{ item.id }}.value = today.toISOString().split('T')[0];
    }
    {% endif %}
    {% endfor %}
});
</script>
{% endblock %}
