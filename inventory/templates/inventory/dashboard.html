{% extends 'inventory/base.html' %}

{% block title %}Dashboard - Inventory Management{% endblock %}
{% block page_title %}Inventory Overview{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="space-y-2">
        <h1 class="font-serif text-3xl md:text-4xl lg:text-5xl tracking-tight text-balance" style="color: #3c2f2f;">
            Inventory Overview
        </h1>
        <p class="text-sm md:text-base" style="color: #8b7e7a;">Real-time insights into your stock performance</p>
    </div>

    <!-- Dashboard Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
        <a href="{% url 'inventory:item_list' %}" class="card stat-card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); text-decoration: none; display: block; transition: all 0.3s ease;">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium" style="color: #8b7e7a;">Total Items</p>
                        <p class="text-2xl font-bold" style="color: #3c2f2f;">{{ total_products|default:"0" }}</p>
                        <div class="flex items-center mt-1">
                            <span class="text-xs" style="color: #8b7e7a;">Active items in inventory</span>
                        </div>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background: #c9a27b;">
                        <i class="fas fa-box text-white"></i>
                    </div>
                </div>
            </div>
        </a>

        <a href="{% url 'inventory:stock_report' %}" class="card stat-card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); text-decoration: none; display: block; transition: all 0.3s ease;">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium" style="color: #8b7e7a;">Total Value</p>
                        <p class="text-2xl font-bold" style="color: #3c2f2f;">₱{{ total_value|floatformat:2|default:"0.00" }}</p>
                        <div class="flex items-center mt-1">
                            {% if value_change > 0 %}
                                <i class="fas fa-arrow-up text-green-600 text-xs mr-1"></i>
                                <span class="text-xs text-green-600">+{{ value_change|floatformat:1 }}% vs last month</span>
                            {% elif value_change < 0 %}
                                <i class="fas fa-arrow-down text-red-600 text-xs mr-1"></i>
                                <span class="text-xs text-red-600">{{ value_change|floatformat:1 }}% vs last month</span>
                            {% else %}
                                <span class="text-xs" style="color: #8b7e7a;">No change vs last month</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background: #c9a27b;">
                        <i class="fas fa-peso-sign text-white"></i>
                    </div>
                </div>
            </div>
        </a>

        <a href="{% url 'inventory:stock_report' %}" class="card stat-card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); text-decoration: none; display: block; transition: all 0.3s ease;">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium" style="color: #8b7e7a;">Low Stock Items</p>
                        <p class="text-2xl font-bold" style="color: #3c2f2f;">{{ low_stock_count|default:"0" }}</p>
                        <div class="flex items-center mt-1">
                            {% if low_stock_count > 0 %}
                                <i class="fas fa-exclamation-triangle text-orange-600 text-xs mr-1"></i>
                                <span class="text-xs text-orange-600">Needs attention</span>
                            {% else %}
                                <span class="text-xs text-green-600">All items well stocked</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background: #c9a27b;">
                        <i class="fas fa-exclamation-triangle text-white"></i>
                    </div>
                </div>
            </div>
        </a>

        <a href="{% url 'inventory:stock_report' %}" class="card stat-card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); text-decoration: none; display: block; transition: all 0.3s ease;">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium" style="color: #8b7e7a;">Out of Stock</p>
                        <p class="text-2xl font-bold" style="color: #3c2f2f;">{{ out_of_stock_count|default:"0" }}</p>
                        <div class="flex items-center mt-1">
                            {% if out_of_stock_count > 0 %}
                                <i class="fas fa-times-circle text-red-600 text-xs mr-1"></i>
                                <span class="text-xs text-red-600">Requires restocking</span>
                            {% else %}
                                <span class="text-xs text-green-600">No items out of stock</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background: #c9a27b;">
                        <i class="fas fa-chart-line text-white"></i>
                    </div>
                </div>
            </div>
        </a>

        <a href="{% url 'inventory:production_list' %}" class="card stat-card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06); text-decoration: none; display: block; transition: all 0.3s ease;">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium" style="color: #8b7e7a;">Finished Goods</p>
                        <p class="text-2xl font-bold" style="color: #3c2f2f;">{{ finished_goods_count|default:"0" }}</p>
                        <div class="flex items-center mt-1">
                            {% if finished_goods_low_stock > 0 %}
                                <i class="fas fa-exclamation-circle text-orange-600 text-xs mr-1"></i>
                                <span class="text-xs text-orange-600">{{ finished_goods_low_stock }} low stock</span>
                            {% else %}
                                <span class="text-xs text-green-600">All well stocked</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="h-12 w-12 rounded-full flex items-center justify-center" style="background: #4ade80;">
                        <i class="fas fa-cookie-bite text-white"></i>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Main Content Grid -->
    <div class="flex gap-8">
        <!-- Left Column - Charts and Tables -->
        <div class="flex-1 space-y-6" style="width: 66.67%;">
            <!-- Stock Value Trend Chart -->
            <div class="card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06);">
                <div class="card-header" style="padding: 1.5rem 1.5rem 0 1.5rem;">
                    <h3 class="text-lg font-semibold" style="color: #3c2f2f;">Stock Value Trend</h3>
                    <p class="text-sm" style="color: #8b7e7a;">Monthly inventory valuation over time</p>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <canvas id="stockTrendChart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('stockTrendChart');
                if (ctx) {
                    const monthlyLabels = {{ monthly_labels|safe }};
                    const monthlyValues = {{ monthly_values|safe }};
                    
                    // Find max value for scaling
                    const maxValue = Math.max(...monthlyValues);
                    
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: monthlyLabels,
                            datasets: [{
                                label: 'Stock Value (₱)',
                                data: monthlyValues,
                                borderColor: '#c9a27b',
                                backgroundColor: 'rgba(201, 162, 123, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#c9a27b',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: '#3c2f2f',
                                    titleColor: '#fff',
                                    bodyColor: '#fff',
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            return '₱' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: '#8b7e7a',
                                        callback: function(value) {
                                            if (value >= 1000) {
                                                return '₱' + (value / 1000).toFixed(0) + 'k';
                                            }
                                            return '₱' + value;
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(139, 126, 122, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: '#8b7e7a'
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            });
            </script>

            <!-- Recent Inventory Table -->
            <div class="card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06);">
                <div class="card-header" style="padding: 1.5rem 1.5rem 0 1.5rem;">
                    <h3 class="text-lg font-semibold" style="color: #3c2f2f;">Recent Inventory</h3>
                    <p class="text-sm" style="color: #8b7e7a;">Latest updates to your product catalog</p>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    {% if recent_items_data %}
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead>
                                    <tr class="border-b" style="border-color: rgba(139,126,122,0.2);">
                                        <th class="text-left py-3 text-sm font-medium" style="color: #8b7e7a;">Product</th>
                                        <th class="text-left py-3 text-sm font-medium" style="color: #8b7e7a;">Category</th>
                                        <th class="text-left py-3 text-sm font-medium" style="color: #8b7e7a;">Stock</th>
                                        <th class="text-left py-3 text-sm font-medium" style="color: #8b7e7a;">Value</th>
                                        <th class="text-left py-3 text-sm font-medium" style="color: #8b7e7a;">Status</th>
                                        <th class="text-left py-3 text-sm font-medium" style="color: #8b7e7a;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item_data in recent_items_data %}
                                    <tr class="border-b" style="border-color: rgba(139,126,122,0.1);">
                                        <td class="py-4">
                                            <div>
                                                <p class="text-sm font-medium" style="color: #3c2f2f;">{{ item_data.item.name }}</p>
                                                <p class="text-xs" style="color: #8b7e7a;">{{ item_data.item.code }}</p>
                                            </div>
                                        </td>
                                        <td class="py-4 text-sm" style="color: #3c2f2f;">{{ item_data.item.get_category_display }}</td>
                                        <td class="py-4 text-sm" style="color: #3c2f2f;">{{ item_data.current_stock|floatformat:2 }} {{ item_data.item.unit }}</td>
                                        <td class="py-4 text-sm" style="color: #3c2f2f;">₱{{ item_data.value|floatformat:2 }}</td>
                                        <td class="py-4">
                                            {% if item_data.status_class == 'danger' %}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background: #dc2626; color: white;">
                                                    {{ item_data.status }}
                                                </span>
                                            {% elif item_data.status_class == 'warning' %}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background: #d4a574; color: #3c2f2f;">
                                                    {{ item_data.status }}
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background: #f3e8d3; color: #3c2f2f;">
                                                    {{ item_data.status }}
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="py-4">
                                            <a href="{% url 'inventory:item_detail' item_data.item.id %}" class="text-sm" style="color: #8b7e7a;">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-sm text-center py-8" style="color: #8b7e7a;">No items found. Start by adding items to your inventory.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column - Sidebar Content -->
        <div class="flex flex-col gap-8" style="width: 33.33%;">
            <!-- Recent Activity -->
            <div class="card" style="background: #fffaf5; border: 1px solid rgba(0,0,0,0.05); border-radius: 14px; box-shadow: 0 6px 16px rgba(0,0,0,0.06);">
                <div class="card-header" style="padding: 1.5rem 1.5rem 0 1.5rem;">
                    <h3 class="text-lg font-semibold" style="color: #3c2f2f;">Recent Activity</h3>
                    <p class="text-sm" style="color: #8b7e7a;">Latest system updates</p>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    {% if recent_activities %}
                        <div class="space-y-4" style="max-height: 400px; overflow-y: auto;">
                            {% for activity in recent_activities %}
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <div class="h-8 w-8 rounded-full flex items-center justify-center" style="background: #8b7e7a;">
                                            {% if activity.action_type == 'create' %}
                                                <i class="fas fa-plus text-white text-xs"></i>
                                            {% elif activity.action_type == 'update' %}
                                                <i class="fas fa-edit text-white text-xs"></i>
                                            {% elif activity.action_type == 'delete' %}
                                                <i class="fas fa-trash text-white text-xs"></i>
                                            {% elif activity.action_type == 'login' %}
                                                <i class="fas fa-sign-in-alt text-white text-xs"></i>
                                            {% elif activity.action_type == 'logout' %}
                                                <i class="fas fa-sign-out-alt text-white text-xs"></i>
                                            {% elif activity.action_type == 'permission_grant' %}
                                                <i class="fas fa-key text-white text-xs"></i>
                                            {% elif activity.action_type == 'permission_revoke' %}
                                                <i class="fas fa-lock text-white text-xs"></i>
                                            {% else %}
                                                <i class="fas fa-info text-white text-xs"></i>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium" style="color: #3c2f2f;">
                                            {{ activity.description|truncatewords:10 }}
                                        </p>
                                        <p class="text-xs" style="color: #8b7e7a;">
                                            {% if activity.user %}{{ activity.user.username }} - {% endif %}
                                            {{ activity.timestamp|timesince }} ago
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-center py-8" style="color: #8b7e7a;">No recent activity to display.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .stat-card {
        cursor: pointer;
    }
    
    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.12) !important;
    }
    
    .stat-card:active {
        transform: translateY(-2px);
    }
</style>
{% endblock %}